<!DOCTYPE html><html class=split lang=ja>
<script src=/link-fixup.js defer=""></script><meta charset=utf-8><meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name=viewport>
<title>HTML Standard, Developer's Edition 日本語訳</title><meta content=#3c790a name=theme-color><link rel=icon href=https://resources.whatwg.org/logo.svg>
<script>
   function toggleStatus(div) {
     div.parentNode.classList.toggle('wrapped');
   }
  </script>
<style>
   .status { min-height: 0.6em; font: 1em sans-serif; width: 9em; padding: 0.3em; position: absolute; z-index: 8; right: 0.3em; background: #EEE; color: black; box-shadow: 0 0 3px #999; overflow: hidden; margin: -2em 0 0 0; border-collapse: initial; border-spacing: initial; }
   .status:hover { z-index: 9; }
   .status:focus-within { z-index: 9; }
   .status.wrapped > :not(input) { display: none; }
   .status > input { position: absolute; left: 0; top: 0; width: 1em; height: 1em; border: none; background: transparent; padding: 0; margin: 0; }
   .status > p { font-size: 0.6em; margin: 0; padding: 0; }
   .status > p + p { padding-top: 0.5em; }
   .status > p > strong { margin-left: 1.5em; }
   .status > .support { display: block; }
   .status > .support > span { padding: 0.2em 0; display: block; display: table; }
   .status > .support > span.partial { color: #666666; filter: grayscale(50%); }
   .status > .support > span.no { color: #CCCCCC; filter: grayscale(100%); }
   .status > .support > span.no::before { opacity: 0.5; }
   .status > .support > span:first-of-type { padding-top: 0.5em; }
   .status > .support > span > span { padding: 0 0.5em; display: table-cell; vertical-align: top; }
   .status > .support > span > span:first-child { width: 100%; }
   .status > .support > span > span:last-child { width: 100%; white-space: pre; padding: 0; }
   .status > .support > span::before { content: ' '; display: table-cell; min-width: 1.5em; height: 1.5em; background: no-repeat center center; background-size: contain; text-align: right; font-size: 0.75em; font-weight: bold; }
   .status > .support > .and_chr::before { background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg); }
   .status > .support > .and_ff::before { background-image: url(https://resources.whatwg.org/browser-logos/firefox.png); }
   .status > .support > .and_uc::before { background-image: url(https://resources.whatwg.org/browser-logos/uc.png); } /* UC Browser for Android */
   .status > .support > .android::before { background-image: url(https://resources.whatwg.org/browser-logos/android.svg); }
   .status > .support > .bb::before { background-image: url(https://resources.whatwg.org/browser-logos/bb.jpg); } /* Blackberry Browser */
   .status > .support > .chrome::before { background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg); }
   .status > .support > .edge::before { background-image: url(https://resources.whatwg.org/browser-logos/edge.svg); }
   .status > .support > .firefox::before { background-image: url(https://resources.whatwg.org/browser-logos/firefox.png); }
   .status > .support > .ie::before { background-image: url(https://resources.whatwg.org/browser-logos/ie.png); }
   .status > .support > .ie_mob::before { background-image: url(https://resources.whatwg.org/browser-logos/ie-mobile.svg); }
   .status > .support > .ios_saf::before { background-image: url(https://resources.whatwg.org/browser-logos/safari-ios.svg); }
   .status > .support > .op_mini::before { background-image: url(https://resources.whatwg.org/browser-logos/opera-mini.png); }
   .status > .support > .op_mob::before { background-image: url(https://resources.whatwg.org/browser-logos/opera.png); }
   .status > .support > .opera::before { background-image: url(https://resources.whatwg.org/browser-logos/opera.png); }
   .status > .support > .safari::before { background-image: url(https://resources.whatwg.org/browser-logos/safari.png); }
   .status > .support > .samsung::before { background-image: url(https://resources.whatwg.org/browser-logos/samsung.png); }
   .status > .caniuse { text-align: right; font-style: italic; width: 100%; }
   .status > .caniuse + p { margin-top: 0.5em; border-top: 1px solid silver; }

   @media (max-width: 767px) {
     .status { right: -9em; }
   }
  </style><link rel=stylesheet href=styles.css>
<body>
  <script async="" src=search.js></script>
  
  
  <header id=head class="head with-buttons">
   <a href=https://whatwg.org/ class=logo><img alt=WHATWG src=https://resources.whatwg.org/logo.svg width=100 height=100></a>
   
   <hgroup><h1><a rel=home href=/dev/>HTML: The Living Standard</a></h1><h2 id=dev-edition-h2 class="no-num no-toc">Developer's Edition — Last Updated <span class=pubdate>2 May 2018</span></h2></hgroup>
   

   <div id=search>
    <input placeholder="Search. Press '/'" autocomplete=off name=query id=query type=search>
    <ol id=results></ol>
   </div>
  </header>

  

  
  

  
  

  

  <nav><a href=web-sockets.html>← 9.3 Web sockets</a> — <a href=./>目次</a> — <a href=workers.html>10 Web workers →</a></nav><ol class=toc><li><ol><li><a href=web-messaging.html#web-messaging><span class=secno>9.4</span> Cross-document messaging</a><ol><li><a href=web-messaging.html#introduction-11><span class=secno>9.4.1</span> Introduction</a></li><li><a href=web-messaging.html#security-postmsg><span class=secno>9.4.2</span> Security</a></li><li><a href=web-messaging.html#posting-messages><span class=secno>9.4.3</span> Posting messages</a></li></ol></li><li><a href=web-messaging.html#channel-messaging><span class=secno>9.5</span> Channel messaging</a><ol><li><a href=web-messaging.html#introduction-12><span class=secno>9.5.1</span> Introduction</a><ol><li><a href=web-messaging.html#examples-5><span class=secno>9.5.1.1</span> Examples</a></li><li><a href=web-messaging.html#ports-as-the-basis-of-an-object-capability-model-on-the-web><span class=secno>9.5.1.2</span> Ports as the basis of an object-capability model on the Web</a></li><li><a href=web-messaging.html#ports-as-the-basis-of-abstracting-out-service-implementations><span class=secno>9.5.1.3</span> Ports as the basis of abstracting out service implementations</a></li></ol></li><li><a href=web-messaging.html#message-channels><span class=secno>9.5.2</span> Message channels</a></li><li><a href=web-messaging.html#message-ports><span class=secno>9.5.3</span> Message ports</a></li><li><a href=web-messaging.html#broadcasting-to-many-ports><span class=secno>9.5.4</span> Broadcasting to many ports</a></li><li><a href=web-messaging.html#ports-and-garbage-collection><span class=secno>9.5.5</span> Ports and garbage collection</a></li></ol></li><li><a href=web-messaging.html#broadcasting-to-other-browsing-contexts><span class=secno>9.6</span> Broadcasting to other browsing contexts</a></li></ol></li></ol><h3 id=web-messaging><span class=secno>9.4</span> <dfn id=crossDocumentMessages>Cross-document messaging</dfn><a href=#web-messaging class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value=⋰ type=button><p class=support><strong>Support:</strong> x-doc-messaging<span class="and_chr yes"><span>Chrome for Android</span> <span>66+</span></span><span class="chrome yes"><span>Chrome</span> <span>4+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>3.2+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11.8+</span></span><span class="firefox yes"><span>Firefox</span> <span>3+</span></span><span class="ie partial"><span>IE (limited)</span> <span>8+</span></span><span class="op_mini yes"><span>Opera Mini</span> <span>all+</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="safari yes"><span>Safari</span> <span>4+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="android yes"><span>Android Browser</span> <span>2.1+</span></span><span class="opera yes"><span>Opera</span> <span>9.5+</span></span><p class=caniuse>Source: <a href="https://caniuse.com/#feat=x-doc-messaging">caniuse.com</a></div>

  <p>Web browsers, for security and privacy reasons, prevent documents in different domains from
  affecting each other; that is, cross-site scripting is disallowed.</p>

  <p>While this is an important security feature, it prevents pages from different domains from
  communicating even when those pages are not hostile. This section introduces a messaging system
  that allows documents to communicate with each other regardless of their source domain, in a way
  designed to not enable cross-site scripting attacks.</p>

  <p class=note>This API <a href=introduction.html#fingerprint-postMessage>has some privacy implications</a> that
  might not be immediately obvious.</p>

  


  <h4 id=introduction-11><span class=secno>9.4.1</span> Introduction<a href=#introduction-11 class=self-link></a></h4>

  

  <div class=example>

   <p>For example, if document A contains an <code id=introduction-11:the-iframe-element><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> element that contains document B,
   and script in document A calls <code id=introduction-11:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code> on the
   <code>Window</code> object of document B, then a message event will be fired on that object,
   marked as originating from the <code>Window</code> of document A. The script in document A might
   look like:</p>

   <pre>var o = document.getElementsByTagName('iframe')[0];
o.contentWindow.postMessage('Hello world', 'https://b.example.org/');</pre>

   <p>To register an event handler for incoming events, the script would use <code>addEventListener()</code> (or similar mechanisms). For example, the script in document B
   might look like:</p>

   <pre>window.addEventListener('message', receiver, false);
function receiver(e) {
  if (e.origin == 'https://example.com') {
    if (e.data == 'Hello world') {
      e.source.postMessage('Hello', e.origin);
    } else {
      alert(e.data);
    }
  }
}</pre>

   <p>This script first checks the domain is the expected domain, and then looks at the message,
   which it either displays to the user, or responds to by sending a message back to the document
   which sent the message in the first place.</p>

  </div>



  <h4 id=security-postmsg><span class=secno>9.4.2</span> Security<a href=#security-postmsg class=self-link></a></h4>

  

  <p id=security-4 class=warning>Use of this API requires extra care to protect users from
  hostile entities abusing a site for their own purposes.</p>

  <p>Authors should check the <code id=security-postmsg:dom-messageevent-origin><a href=comms.html#dom-messageevent-origin>origin</a></code> attribute to
  ensure that messages are only accepted from domains that they expect to receive messages from.
  Otherwise, bugs in the author's message handling code could be exploited by hostile sites.</p>

  <p>Furthermore, even after checking the <code id=security-postmsg:dom-messageevent-origin-2><a href=comms.html#dom-messageevent-origin>origin</a></code>
  attribute, authors should also check that the data in question is of the expected format.
  Otherwise, if the source of the event has been attacked using a cross-site scripting flaw, further
  unchecked processing of information sent using the <code id=security-postmsg:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code> method could result in the attack being
  propagated into the receiver.</p>

  <p>Authors should not use the wildcard keyword (*) in the <var>targetOrigin</var>
  argument in messages that contain any confidential information, as otherwise there is no way to
  guarantee that the message is only delivered to the recipient to which it was intended.</p>

  <hr>

  <p>Authors who accept messages from any origin are encouraged to consider the risks of a
  denial-of-service attack. An attacker could send a high volume of messages; if the receiving page
  performs expensive computation or causes network traffic to be sent for each such message, the
  attacker's message could be multiplied into a denial-of-service attack. Authors are encouraged to
  employ rate limiting (only accepting a certain number of messages per minute) to make such attacks
  impractical.</p>


  




  <h4 id=posting-messages><span class=secno>9.4.3</span> Posting messages<a href=#posting-messages class=self-link></a></h4>

  <dl class=domintro><dt><var>window</var> . <code id=dom-window-postmessage>postMessage</code>(<var>message</var>, <var>targetOrigin</var> [, <var>transfer</var> ] )<dd>

    <p>Posts a message to the given window. Messages can be structured objects, e.g. nested objects
    and arrays, can contain JavaScript values (strings, numbers, <code id=posting-messages:date><a data-x-internal=date href=https://tc39.github.io/ecma262/#sec-date-objects>Date</a></code>
    objects, etc), and can contain certain data objects such as <code id=posting-messages:file><a data-x-internal=file href=https://w3c.github.io/FileAPI/#dfn-file>File</a></code> <code id=posting-messages:blob><a data-x-internal=blob href=https://w3c.github.io/FileAPI/#dfn-Blob>Blob</a></code>,
    <code id=posting-messages:filelist><a data-x-internal=filelist href=https://triple-underscore.github.io/File_API-ja.html#filelist-section>FileList</a></code>, and <code id=posting-messages:idl-arraybuffer><a data-x-internal=idl-arraybuffer href=https://triple-underscore.github.io/WebIDL-ja.html#idl-ArrayBuffer>ArrayBuffer</a></code> objects.</p>

    <p>Objects listed in <var>transfer</var> are transferred, not just cloned, meaning that
    they are no longer usable on the sending side.</p>

    <p>If the origin of the target window doesn't match the given origin, the message is discarded,
    to avoid information leakage. To send the message to the target regardless of origin, set the
    target origin to "<code>*</code>". To restrict the message to same-origin targets only,
    without needing to explicitly state the origin, set the target origin to "<code>/</code>".</p>

    <p>Throws a <a id=posting-messages:datacloneerror href=https://triple-underscore.github.io/WebIDL-ja.html#datacloneerror data-x-internal=datacloneerror>"<code>DataCloneError</code>"</a> <code id=posting-messages:domexception><a data-x-internal=domexception href=https://triple-underscore.github.io/WebIDL-ja.html#dfn-DOMException>DOMException</a></code> if
    <var>transfer</var> array contains duplicate objects or if <var>message</var> could not be
    cloned.</p>

   </dl>

  <p class=note>When posting a message to a <code>Window</code> of a <a id=posting-messages:browsing-context href=browsers.html#browsing-context>browsing context</a>
  that has just been navigated to a new <code>Document</code> is likely to result in the message not
  receiving its intended recipient: the scripts in the target <a id=posting-messages:browsing-context-2 href=browsers.html#browsing-context>browsing context</a> have to
  have had time to set up listeners for the messages. Thus, for instance, in situations where a
  message is to be sent to the <code>Window</code> of newly created child <code id=posting-messages:the-iframe-element><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code>,
  authors are advised to have the child <code>Document</code> post a message to their parent
  announcing their readiness to receive messages, and for the parent to wait for this message before
  beginning posting messages.</p>

  




  <h3 id=channel-messaging><span class=secno>9.5</span> <dfn>Channel messaging</dfn><a href=#channel-messaging class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value=⋰ type=button><p class=support><strong>Support:</strong> channel-messaging<span class="and_chr yes"><span>Chrome for Android</span> <span>66+</span></span><span class="chrome yes"><span>Chrome</span> <span>4+</span></span><span class="ios_saf yes"><span>iOS Safari</span> <span>5.0+</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11.8+</span></span><span class="firefox yes"><span>Firefox</span> <span>41+</span></span><span class="ie yes"><span>IE</span> <span>10+</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="samsung yes"><span>Samsung Internet</span> <span>4+</span></span><span class="safari yes"><span>Safari</span> <span>5+</span></span><span class="edge yes"><span>Edge</span> <span>12+</span></span><span class="android yes"><span>Android Browser</span> <span>4.4+</span></span><span class="opera yes"><span>Opera</span> <span>10.6+</span></span><p class=caniuse>Source: <a href="https://caniuse.com/#feat=channel-messaging">caniuse.com</a></div>

  <h4 id=introduction-12><span class=secno>9.5.1</span> Introduction<a href=#introduction-12 class=self-link></a></h4>

  

  <p>To enable independent pieces of code (e.g. running in different <a href=browsers.html#browsing-context id=introduction-12:browsing-context>browsing contexts</a>) to communicate directly, authors can use <a href=#channel-messaging id=introduction-12:channel-messaging>channel
  messaging</a>.</p>

  <p>Communication channels in this mechanism are implemented as two-ways pipes, with a port at each
  end. Messages sent in one port are delivered at the other port, and vice-versa. Messages are
  delivered as DOM events, without interrupting or blocking running <span>tasks</span>.</p>

  <p>To create a connection (two "entangled" ports), the <code>MessageChannel()</code>
  constructor is called:</p>

  <pre>var channel = new MessageChannel();</pre>

  <p>One of the ports is kept as the local port, and the other port is sent to the remote code, e.g.
  using <code id=introduction-12:dom-window-postmessage><a href=#dom-window-postmessage>postMessage()</a></code>:</p>

  <pre>otherWindow.postMessage('hello', 'https://example.com', [channel.port2]);</pre>

  <p>To send messages, the <code id=introduction-12:dom-messageport-postmessage><a href=#dom-messageport-postmessage>postMessage()</a></code> method on
  the port is used:</p>

  <pre>channel.port1.postMessage('hello');</pre>

  <p>To receive messages, one listens to <code id=introduction-12:event-message><a href=indices.html#event-message>message</a></code> events:</p>

  <pre>channel.port1.onmessage = handleMessage;
function handleMessage(event) {
  // message is in event.data
  // ...
}</pre>

  <p>Data sent on a port can be structured data; for example here an array of strings is passed on a
  <code>MessagePort</code>:</p>

  <pre>port1.postMessage(['hello', 'world']);</pre>


  <h5 id=examples-5><span class=secno>9.5.1.1</span> Examples<a href=#examples-5 class=self-link></a></h5>

  

  <div class=example>

   <p>In this example, two JavaScript libraries are connected to each other using
   <code>MessagePort</code>s. This allows the libraries to later be hosted in different frames, or
   in <code id=examples-5:worker><a href=workers.html#worker>Worker</a></code> objects, without any change to the APIs.</p>

   <pre>&lt;script src="contacts.js"&gt;&lt;/script&gt; &lt;!-- exposes a contacts object --&gt;
&lt;script src="compose-mail.js"&gt;&lt;/script&gt; &lt;!-- exposes a composer object --&gt;
&lt;script&gt;
 var channel = new MessageChannel();
 composer.addContactsProvider(channel.port1);
 contacts.registerConsumer(channel.port2);
&lt;/script&gt;</pre>

   <p>Here's what the "addContactsProvider()" function's implementation could look like:</p>

   <pre>function addContactsProvider(port) {
  port.onmessage = function (event) {
    switch (event.data.messageType) {
      'search-result': handleSearchResult(event.data.results); break;
      'search-done': handleSearchDone(); break;
      'search-error': handleSearchError(event.data.message); break;
      // ...
    }
  };
};</pre>

   <p>Alternatively, it could be implemented as follows:</p>

   <pre>function addContactsProvider(port) {
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-result')
      handleSearchResult(event.data.results);
  });
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-done')
      handleSearchDone();
  });
  port.addEventListener('message', function (event) {
    if (event.data.messageType == 'search-error')
      handleSearchError(event.data.message);
  });
  // ...
  port.start();
};</pre>

   <p>The key difference is that when using <code id=examples-5:dom-eventtarget-addeventlistener><a data-x-internal=dom-eventtarget-addeventlistener href=https://triple-underscore.github.io/DOM4-ja.html#dom-eventtarget-addeventlistener>addEventListener()</a></code>, the <code id=examples-5:dom-messageport-start><a href=#dom-messageport-start>start()</a></code> method must also be invoked. When using <code>onmessage</code>, the call to <code id=examples-5:dom-messageport-start-2><a href=#dom-messageport-start>start()</a></code> is implied.</p>

   <p>The <code id=examples-5:dom-messageport-start-3><a href=#dom-messageport-start>start()</a></code> method, whether called explicitly or
   implicitly (by setting <code>onmessage</code>), starts the
   flow of messages: messages posted on message ports are initially paused, so that they don't get
   dropped on the floor before the script has had a chance to set up its handlers.</p>

  </div>


  <h5 id=ports-as-the-basis-of-an-object-capability-model-on-the-web><span class=secno>9.5.1.2</span> Ports as the basis of an object-capability model on the Web<a href=#ports-as-the-basis-of-an-object-capability-model-on-the-web class=self-link></a></h5>

  

  <p>Ports can be viewed as a way to expose limited capabilities (in the object-capability model
  sense) to other actors in the system. This can either be a weak capability system, where the ports
  are merely used as a convenient model within a particular origin, or as a strong capability model,
  where they are provided by one origin <var>provider</var> as the only mechanism by which
  another origin <var>consumer</var> can effect change in or obtain information from <var>provider</var>.</p>

  <p>For example, consider a situation in which a social Web site embeds in one <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code>
  the user's e-mail contacts provider (an address book site, from a second origin), and in a second
  <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-2><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> a game (from a third origin). The outer social site and the game in the second
  <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-3><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> cannot access anything inside the first <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-4><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code>; together they can
  only:</p>

  <ul class=brief><li><span>Navigate</span> the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-5><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> to a new <a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:url href=https://triple-underscore.github.io/URL-ja.html#concept-url data-x-internal=url>URL</a>, such as the same
   <a id=ports-as-the-basis-of-an-object-capability-model-on-the-web:url-2 href=https://triple-underscore.github.io/URL-ja.html#concept-url data-x-internal=url>URL</a> but with a different <a href=https://triple-underscore.github.io/URL-ja.html#concept-url-fragment id=ports-as-the-basis-of-an-object-capability-model-on-the-web:concept-url-fragment data-x-internal=concept-url-fragment>fragment</a>,
   causing the <code>Window</code> in the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-6><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> to receive a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-hashchange><a href=indices.html#event-hashchange>hashchange</a></code> event.</li><li>Resize the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-7><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code>, causing the <code>Window</code> in the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-8><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> to
   receive a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-resize><a data-x-internal=event-resize href=https://triple-underscore.github.io/cssom-view-ja.html#eventdef-window-resize>resize</a></code> event.</li><li>Send a <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:event-message><a href=indices.html#event-message>message</a></code> event to the <code>Window</code> in the
   <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:the-iframe-element-9><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> using the <code id=ports-as-the-basis-of-an-object-capability-model-on-the-web:dom-window-postmessage><a href=#dom-window-postmessage>window.postMessage()</a></code>
   API.</li></ul>

  <p>The contacts provider can use these methods, most particularly the third one, to provide an API
  that can be accessed by other origins to manipulate the user's address book. For example, it could
  respond to a message "<code>add-contact Guillaume Tell
  &lt;tell@pomme.example.net&gt;</code>" by adding the given person and e-mail address to the user's
  address book.</p>

  <p>To avoid any site on the Web being able to manipulate the user's contacts, the contacts
  provider might only allow certain trusted sites, such as the social site, to do this.</p>

  <p>Now suppose the game wanted to add a contact to the user's address book, and that the social
  site was willing to allow it to do so on its behalf, essentially "sharing" the trust that the
  contacts provider had with the social site. There are several ways it could do this; most simply,
  it could just proxy messages between the game site and the contacts site. However, this solution
  has a number of difficulties: it requires the social site to either completely trust the game site
  not to abuse the privilege, or it requires that the social site verify each request to make sure
  it's not a request that it doesn't want to allow (such as adding multiple contacts, reading the
  contacts, or deleting them); it also requires some additional complexity if there's ever the
  possibility of multiple games simultaneously trying to interact with the contacts provider.</p>

  <p>Using message channels and <code>MessagePort</code> objects, however, all of these problems can
  go away. When the game tells the social site that it wants to add a contact, the social site can
  ask the contacts provider not for it to add a contact, but for the <em>capability</em> to add a
  single contact. The contacts provider then creates a pair of <code>MessagePort</code> objects, and
  sends one of them back to the social site, who forwards it on to the game. The game and the
  contacts provider then have a direct connection, and the contacts provider knows to only honor a
  single "add contact" request, nothing else. In other words, the game has been granted the
  capability to add a single contact.</p>


  <h5 id=ports-as-the-basis-of-abstracting-out-service-implementations><span class=secno>9.5.1.3</span> Ports as the basis of abstracting out service implementations<a href=#ports-as-the-basis-of-abstracting-out-service-implementations class=self-link></a></h5>

  

  <p>Continuing the example from the previous section, consider the contacts provider in particular.
  While an initial implementation might have simply used <code id=ports-as-the-basis-of-abstracting-out-service-implementations:xmlhttprequest><a data-x-internal=xmlhttprequest href=https://triple-underscore.github.io/XHR-ja.html#xmlhttprequest>XMLHttpRequest</a></code> objects in the
  service's <code id=ports-as-the-basis-of-abstracting-out-service-implementations:the-iframe-element><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code>, an evolution of the service might instead want to use a <a href=workers.html#sharedworker id=ports-as-the-basis-of-abstracting-out-service-implementations:sharedworker>shared worker</a> with a single <code>WebSocket</code> connection.</p>

  <p>If the initial design used <code>MessagePort</code> objects to grant capabilities, or even just
  to allow multiple simultaneous independent sessions, the service implementation can switch from
  the <code id=ports-as-the-basis-of-abstracting-out-service-implementations:xmlhttprequest-2><a data-x-internal=xmlhttprequest href=https://triple-underscore.github.io/XHR-ja.html#xmlhttprequest>XMLHttpRequest</a></code>s-in-each-<code id=ports-as-the-basis-of-abstracting-out-service-implementations:the-iframe-element-2><a href=iframe-embed-object.html#the-iframe-element>iframe</a></code> model to the
  shared-<code>WebSocket</code> model without changing the API at all: the ports on the service
  provider side can all be forwarded to the shared worker without it affecting the users of the API
  in the slightest.</p>



  <h4 id=message-channels><span class=secno>9.5.2</span> Message channels<a href=#message-channels class=self-link></a></h4>

  

  <dl class=domintro><dt><var>channel</var> = new <code id=dom-messagechannel>MessageChannel</code>()<dd>

    <p>Returns a new <code>MessageChannel</code> object with two new <code>MessagePort</code> objects.</p>

   <dt><var>channel</var> . <code id=dom-messagechannel-port1>port1</code><dd>

    <p>Returns the first <code>MessagePort</code> object.</p>

   <dt><var>channel</var> . <code id=dom-messagechannel-port2>port2</code><dd>

    <p>Returns the second <code>MessagePort</code> object.</p>

   </dl>

  



  <h4 id=message-ports><span class=secno>9.5.3</span> Message ports<a href=#message-ports class=self-link></a></h4>

  <p>Each channel has two message ports. Data sent through one port is received by the other port,
  and vice versa.</p>

  

  <dl class=domintro><dt><var>port</var> . <code id=dom-messageport-postmessage>postMessage</code>(<var>message</var> [, <var>transfer</var>] )<dd>
    <p>Posts a message through the channel. Objects listed in <var>transfer</var> are
    transferred, not just cloned, meaning that they are no longer usable on the sending side.</p>

    <p>Throws a <a id=message-ports:datacloneerror href=https://triple-underscore.github.io/WebIDL-ja.html#datacloneerror data-x-internal=datacloneerror>"<code>DataCloneError</code>"</a> <code id=message-ports:domexception><a data-x-internal=domexception href=https://triple-underscore.github.io/WebIDL-ja.html#dfn-DOMException>DOMException</a></code> if
    <var>transfer</var> contains duplicate objects or <var>port</var>, or if <var>message</var>
    could not be cloned.</p>
   <dt><var>port</var> . <code id=dom-messageport-start>start</code>()<dd><p>Begins dispatching messages received on the port.<dt><var>port</var> . <code id=dom-messageport-close>close</code>()<dd><p>Disconnects the port, so that it is no longer active.</dl>

  


  <h4 id=broadcasting-to-many-ports><span class=secno>9.5.4</span> Broadcasting to many ports<a href=#broadcasting-to-many-ports class=self-link></a></h4>

  

  <p>Broadcasting to many ports is in principle relatively simple: keep an array of
  <code>MessagePort</code> objects to send messages to, and iterate through the array to send a
  message. However, this has one rather unfortunate effect: it prevents the ports from being garbage
  collected, even if the other side has gone away. To avoid this problem, implement a simple
  protocol whereby the other side acknowledges it still exists. If it doesn't do so after a certain
  amount of time, assume it's gone, close the <code>MessagePort</code> object, and let it be garbage
  collected.</p>


  <h4 id=ports-and-garbage-collection><span class=secno>9.5.5</span> Ports and garbage collection<a href=#ports-and-garbage-collection class=self-link></a></h4>

  

  <p class=note>Authors are strongly encouraged to explicitly close <code>MessagePort</code>
  objects to disentangle them, so that their resources can be recollected. Creating many
  <code>MessagePort</code> objects and discarding them without closing them can lead to high
  transient memory usage since garbage collection is not necessarily performed promptly, especially
  for <code>MessagePort</code>s where garbage collection can involve cross-process coordination.</p>



  <h3 id=broadcasting-to-other-browsing-contexts><span class=secno>9.6</span> <dfn>Broadcasting to other browsing contexts</dfn><a href=#broadcasting-to-other-browsing-contexts class=self-link></a></h3><div class=status><input onclick=toggleStatus(this) value=⋰ type=button><p class=support><strong>Support:</strong> broadcastchannel<span class="and_chr yes"><span>Chrome for Android</span> <span>66+</span></span><span class="chrome yes"><span>Chrome</span> <span>54+</span></span><span class="ios_saf no"><span>iOS Safari</span> <span>None</span></span><span class="and_uc yes"><span>UC Browser for Android</span> <span>11.8+</span></span><span class="firefox yes"><span>Firefox</span> <span>38+</span></span><span class="ie no"><span>IE</span> <span>None</span></span><span class="op_mini no"><span>Opera Mini</span> <span>None</span></span><span class="samsung no"><span>Samsung Internet</span> <span>None</span></span><span class="safari no"><span>Safari</span> <span>None</span></span><span class="edge no"><span>Edge</span> <span>None</span></span><span class="android yes"><span>Android Browser</span> <span>62+</span></span><span class="opera yes"><span>Opera</span> <span>41+</span></span><p class=caniuse>Source: <a href="https://caniuse.com/#feat=broadcastchannel">caniuse.com</a></div>

  <p>Pages on a single <a id=broadcasting-to-other-browsing-contexts:concept-origin href=origin.html#concept-origin>origin</a> opened by the same user in the same user agent but in
  different unrelated <a href=browsers.html#browsing-context id=broadcasting-to-other-browsing-contexts:browsing-context>browsing contexts</a> sometimes need to
  send notifications to each other, for example "hey, the user logged in over here, check your
  credentials again".</p>

  <p>For elaborate cases, e.g. to manage locking of shared state, to manage synchronization of
  resources between a server and multiple local clients, to share a <code>WebSocket</code>
  connection with a remote host, and so forth, <a href=workers.html#sharedworker id=broadcasting-to-other-browsing-contexts:sharedworker>shared workers</a> are
  the most appropriate solution.</p>

  <p>For simple cases, though, where a shared worker would be an unreasonable overhead, authors can
  use the simple channel-based broadcast mechanism described in this section.</p>

  

  <dl class=domintro><dt><var>broadcastChannel</var> = new <code id=dom-broadcastchannel>BroadcastChannel</code>(<var>name</var>)<dd>

    <p>Returns a new <code>BroadcastChannel</code> object via which messages for the given channel
    name can be sent and received.</p>

   <dt><var>broadcastChannel</var> . <code id=dom-broadcastchannel-name>name</code><dd>

    <p>Returns the channel name (as passed to the constructor).</p>

   <dt><var>broadcastChannel</var> . <code id=dom-broadcastchannel-postmessage>postMessage</code>(<var>message</var>)<dd>

    <p>Sends the given message to other <code>BroadcastChannel</code> objects set up for this channel. Messages can be structured objects, e.g. nested objects and arrays.</p>

   <dt><var>broadcastChannel</var> . <code id=dom-broadcastchannel-close>close</code>()<dd>

    <p>Closes the <code>BroadcastChannel</code> object, opening it up to garbage collection.</p>

   </dl>

  

  <div class=example>

   <p>Suppose a page wants to know when the user logs out, even when the user does so from another
   tab at the same site:</p>

   <pre>var authChannel = new BroadcastChannel('auth');
authChannel.onmessage = function (event) {
  if (event.data == 'logout')
    showLogout();
}

function logoutRequested() {
  // called when the user asks us to log them out
  doLogout();
  showLogout();
  authChannel.postMessage('logout');
}

function doLogout() {
  // actually log the user out (e.g. clearing cookies)
  // ...
}

function showLogout() {
  // update the UI to indicate we're logged out
  // ...
}</pre>

  </div>





  <nav><a href=web-sockets.html>← 9.3 Web sockets</a> — <a href=./>目次</a> — <a href=workers.html>10 Web workers →</a></nav>
</body></html>